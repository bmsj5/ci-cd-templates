---
- name: Bootstrap HA K3s Cluster
  hosts: all
  become: true
  vars_files:
    - group_vars/k3s.yml

  pre_tasks:
    - name: Get number of control plane nodes from environment
      ansible.builtin.set_fact:
        num_control_nodes: "{{ lookup('env', 'NUMBER_OF_CONTROL_PLANE_NODES') | default('', true) }}"
    
    - name: Calculate node index in inventory
      ansible.builtin.set_fact:
        node_index: "{{ groups['all'].index(inventory_hostname) }}"
    
    - name: Set k3s_control_node fact based on NUMBER_OF_CONTROL_PLANE_NODES
      ansible.builtin.set_fact:
        k3s_control_node: >-
          {{ (num_control_nodes == '' or num_control_nodes is not defined) or 
             (num_control_nodes | int > 0 and node_index < (num_control_nodes | int)) }}

  roles:
    - role: xanmanning.k3s

  post_tasks:
    # Enable static CPU manager policy for CPU pinning
    # Official K3s method: https://docs.k3s.io/installation/configuration
    # This enables dedicated CPU cores for pods with Guaranteed QoS (integer CPU requests == limits)
    - name: Ensure K3s config directory exists
      ansible.builtin.file:
        path: /etc/rancher/k3s/config.yaml.d
        state: directory
        mode: "0755"

    - name: Configure static CPU manager policy
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/config.yaml.d/99-cpu-manager.yaml
        content: |
          kubelet-arg:
            - "cpu-manager-policy=static"
        mode: "0644"
      notify: apply cpu manager policy

  handlers:
    - name: apply cpu manager policy
      block:
        - name: Clear CPU manager state file
          ansible.builtin.file:
            path: /var/lib/kubelet/cpu_manager_state
            state: absent
          failed_when: false

        - name: Restart K3s to apply CPU manager policy
          ansible.builtin.systemd:
            name: k3s
            state: restarted
            daemon_reload: yes