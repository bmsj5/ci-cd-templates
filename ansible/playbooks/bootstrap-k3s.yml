- name: Bootstrap HA K3s Cluster
  hosts: all
  become: true
  vars_files:
    - group_vars/k3s.yml

  pre_tasks:
    - name: Get number of control plane nodes from environment
      ansible.builtin.set_fact:
        num_control_nodes: "{{ lookup('env', 'NUMBER_OF_CONTROL_PLANE_NODES') | default('', true) }}"
    
    - name: Calculate node index in inventory
      ansible.builtin.set_fact:
        node_index: "{{ groups['all'].index(inventory_hostname) }}"
    
    - name: Set k3s_control_node fact based on NUMBER_OF_CONTROL_PLANE_NODES
      ansible.builtin.set_fact:
        k3s_control_node: >-
          {{ (num_control_nodes == '' or num_control_nodes is not defined) or 
             (num_control_nodes | int > 0 and node_index < (num_control_nodes | int)) }}

  roles:
    - role: xanmanning.k3s

  post_tasks:
    # Enable static CPU manager policy for CPU pinning
    # Official K3s method: https://docs.k3s.io/installation/configuration
    # This enables dedicated CPU cores for pods with Guaranteed QoS (integer CPU requests == limits)
    - name: Ensure K3s config directory exists
      ansible.builtin.file:
        path: /etc/rancher/k3s/config.yaml.d
        state: directory
        mode: "0755"

    - name: Get number of CPU cores
      ansible.builtin.command: nproc
      register: cpu_cores_result
      changed_when: false

    - name: Calculate kube-reserved CPU using GKE formula
      ansible.builtin.set_fact:
        cpu_cores: "{{ cpu_cores_result.stdout | int }}"
        reserved_cpu_m: >-
          {%- set cores = cpu_cores_result.stdout | int -%}
          {%- set total = 0 -%}
          {%- if cores >= 1 -%}
            {%- set total = total + 60 -%}
            {%- if cores >= 2 -%}
              {%- set total = total + 10 -%}
              {%- if cores >= 4 -%}
                {%- set total = total + 10 -%}
                {%- if cores > 4 -%}
                  {%- set total = total + ((cores - 4) * 2.5) | round(0, 'floor') | int -%}
                {%- endif -%}
              {%- elif cores == 3 -%}
                {%- set total = total + 5 -%}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}
            {%- set total = 60 -%}
          {%- endif -%}
          {{ total | int }}

    - name: Clear CPU manager state file before applying policy
      ansible.builtin.file:
        path: /var/lib/kubelet/cpu_manager_state
        state: absent
      failed_when: false

    - name: Configure static CPU manager policy
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/config.yaml.d/99-cpu-manager.yaml
        content: |
          kubelet-arg:
            - "cpu-manager-policy=static"
            - "system-reserved=cpu={{ reserved_cpu_m }}m"
        mode: "0644"

    - name: Restart K3s to apply CPU manager policy
      ansible.builtin.systemd:
        name: k3s
        state: restarted
        daemon_reload: yes

    # Configure CoreDNS High Availability
    # K3s v1.35+ deploys CoreDNS as a regular Deployment
    # We use kubectl commands instead of kubernetes.core.k8s to avoid Python library dependencies
    # Only run on the first control-plane node to avoid conflicts.
    - name: Configure CoreDNS HA
      when:
        - k3s_control_node | bool
        - inventory_hostname == groups['all'][0]
      block:
        - name: Calculate CoreDNS replica count
          ansible.builtin.set_fact:
            coredns_replicas: "{{ groups['all'] | length if (groups['all'] | length <= 3) else 3 }}"
            coredns_pdb_min: "{{ (groups['all'] | length - 1) if (groups['all'] | length > 1 and groups['all'] | length <= 3) else 2 }}"

        - name: Wait for CoreDNS deployment to be available
          ansible.builtin.command:
            cmd: kubectl get deployment coredns -n kube-system
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: coredns_exists
          retries: 30
          delay: 10
          until: coredns_exists.rc == 0
          changed_when: false

        - name: Scale CoreDNS deployment replicas to {{ coredns_replicas }}
          ansible.builtin.command:
            cmd: kubectl scale deployment coredns -n kube-system --replicas={{ coredns_replicas }}
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: scale_result
          changed_when: "'scaled' in scale_result.stdout"

        - name: Add topology spread constraints to CoreDNS
          ansible.builtin.command:
            cmd: |
              kubectl patch deployment coredns -n kube-system --type='json' -p='[{
                "op": "add",
                "path": "/spec/template/spec/topologySpreadConstraints",
                "value": [{
                  "maxSkew": 1,
                  "topologyKey": "kubernetes.io/hostname",
                  "whenUnsatisfiable": "DoNotSchedule",
                  "labelSelector": {
                    "matchLabels": {
                      "k8s-app": "kube-dns"
                    }
                  }
                }]
              }]'
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: topology_result
          changed_when: "'patched' in topology_result.stdout"
          failed_when: 
            - topology_result.rc != 0
            - "'already exists' not in topology_result.stderr"

        - name: Create PodDisruptionBudget manifest for CoreDNS
          ansible.builtin.copy:
            content: |
              apiVersion: policy/v1
              kind: PodDisruptionBudget
              metadata:
                name: coredns
                namespace: kube-system
              spec:
                minAvailable: {{ coredns_pdb_min }}
                selector:
                  matchLabels:
                    k8s-app: kube-dns
            dest: /tmp/coredns-pdb.yaml
            mode: '0644'

        - name: Create PodDisruptionBudget for CoreDNS
          ansible.builtin.command:
            cmd: kubectl apply -f /tmp/coredns-pdb.yaml
          environment:
            KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          register: pdb_result
          changed_when: "'created' in pdb_result.stdout or 'configured' in pdb_result.stdout"

        - name: Remove temporary PDB manifest
          ansible.builtin.file:
            path: /tmp/coredns-pdb.yaml
            state: absent