- name: Bootstrap HA RKE2 Cluster
  hosts: all
  become: true
  gather_facts: false  # Disable problematic setup module
  vars_files:
    - group_vars/rke2.yml
  vars:
    # SSH settings to prevent multiplexing issues
    ansible_ssh_pipelining: false
    ansible_ssh_control_path: ""

  pre_tasks:
    # Manual fact gathering to replace the problematic setup module
    - name: Gather basic facts manually
      ansible.builtin.set_fact:
        ansible_distribution: "{{ lookup('pipe', 'lsb_release -si 2>/dev/null || cat /etc/os-release | grep ^ID= | cut -d= -f2 | tr -d \\"', ignore_errors=True) | default('unknown') }}"
        ansible_distribution_major_version: "{{ lookup('pipe', 'lsb_release -sr 2>/dev/null || cat /etc/os-release | grep ^VERSION_ID= | cut -d= -f2 | cut -d. -f1 | tr -d \\"', ignore_errors=True) | default('unknown') }}"
        ansible_architecture: "{{ lookup('pipe', 'uname -m', ignore_errors=True) | default('unknown') }}"

    - name: DEBUG - Check SSH connection settings
      debug:
        msg: |
          SSH Settings:
          - ansible_ssh_pipelining: {{ ansible_ssh_pipelining | default('undefined') }}
          - ansible_ssh_control_path: {{ ansible_ssh_control_path | default('undefined') }}
          - ansible_connection: {{ ansible_connection | default('undefined') }}
          - ansible_ssh_executable: {{ ansible_ssh_executable | default('undefined') }}

    - name: DEBUG - Test simple SSH command
      command: echo "SSH test successful"
      register: ssh_test

    - name: DEBUG - Show SSH test result
      debug:
        var: ssh_test.stdout

    - name: DEBUG - Test remote shell environment
      shell: |
        echo "=== Shell Information ==="
        echo "SHELL: $SHELL"
        echo "PATH: $PATH"
        echo "USER: $(whoami)"
        echo "PWD: $(pwd)"
        echo ""
        echo "=== Testing command components ==="
        echo "umask test:" && umask 77 && echo "umask OK"
        echo "echo test:" && echo "/tmp" && echo "echo OK"
        echo "mkdir test:" && mkdir -p /tmp/test-debug-dir && echo "mkdir OK" && rm -rf /tmp/test-debug-dir
        echo ""
        echo "=== Testing backtick execution ==="
        result=$(echo "/tmp")
        echo "Backtick result: $result"
        echo "Backtick test: $([ "$result" = "/tmp" ] && echo "SUCCESS" || echo "FAILED")"
      register: shell_debug
      ignore_errors: true

    - name: DEBUG - Show shell debug results
      debug:
        msg: "{{ shell_debug.stdout | default('NO OUTPUT') }}"

    - name: DEBUG - Test exact Ansible temp dir command
      shell: eval '( umask 77 && mkdir -p "` echo /tmp `" && mkdir "` echo /tmp/ansible-test `" && echo ansible-test="` echo /tmp/ansible-test `" )'
      register: ansible_cmd_test
      ignore_errors: true

    - name: DEBUG - Show Ansible command test result
      debug:
        msg: |
          Ansible-style command test:
          - rc: {{ ansible_cmd_test.rc | default('undefined') }}
          - stdout: {{ ansible_cmd_test.stdout | default('undefined') }}
          - stderr: {{ ansible_cmd_test.stderr | default('undefined') }}

    - name: Get number of control plane nodes from environment
      ansible.builtin.set_fact:
        num_control_nodes: "{{ lookup('env', 'NUMBER_OF_CONTROL_PLANE_NODES') | default('', true) }}"
      run_once: true

    - name: Calculate node index in inventory
      ansible.builtin.set_fact:
        node_index: "{{ groups['all'].index(inventory_hostname) }}"

    - name: Set rke2_control_node fact based on NUMBER_OF_CONTROL_PLANE_NODES
      ansible.builtin.set_fact:
        rke2_control_node: >-
          {{ (num_control_nodes == '' or num_control_nodes is not defined) or
             (num_control_nodes | int > 0 and node_index | int < (num_control_nodes | int)) }}

    - name: Dynamically create rke2_servers group
      ansible.builtin.group_by:
        key: rke2_servers
      when: rke2_control_node | bool

    - name: Get number of CPU cores for GKE-style reservations
      ansible.builtin.command: nproc
      register: cpu_cores_result
      changed_when: false

    - name: Calculate kube-reserved CPU using GKE formula
      ansible.builtin.set_fact:
        cpu_cores: "{{ cpu_cores_result.stdout | int }}"
        reserved_cpu_m: >-
          {%- set cores = cpu_cores_result.stdout | int -%}
          {%- set total = 0 -%}
          {%- if cores >= 1 -%}
            {%- set total = total + 60 -%}
            {%- if cores >= 2 -%}
              {%- set total = total + 10 -%}
              {%- if cores >= 4 -%}
                {%- set total = total + 10 -%}
                {%- if cores > 4 -%}
                  {%- set total = total + ((cores - 4) * 2.5) | round(0, 'floor') | int -%}
                {%- endif -%}
              {%- elif cores == 3 -%}
                {%- set total = total + 5 -%}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}
            {%- set total = 60 -%}
          {%- endif -%}
          {{ total | int }}

  roles:
    - role: rancherfederal.rke2_ansible.rke2

  post_tasks:
    # -------------------------------------------------------------
    # Deploy RKE2 CoreDNS HA HelmChartConfig manifest
    # -------------------------------------------------------------
    - name: Deploy RKE2 CoreDNS HA HelmChartConfig manifest
      when:
        - rke2_control_node | bool
        - inventory_hostname == groups['all'][0]
      ansible.builtin.template:
        src: rke2-coredns-config.yaml.j2
        dest: /var/lib/rancher/rke2/server/manifests/rke2-coredns-config.yaml
        mode: "0644"

    # -------------------------------------------------------------
    # Deploy RKE2 Traefik HA HelmChartConfig manifest
    # -------------------------------------------------------------
    - name: Deploy RKE2 Traefik HA HelmChartConfig manifest
      when:
        - rke2_control_node | bool
        - inventory_hostname == groups['all'][0]
      ansible.builtin.template:
        src: rke2-traefik-config.yaml.j2
        dest: /var/lib/rancher/rke2/server/manifests/rke2-traefik-config.yaml
        mode: "0644"