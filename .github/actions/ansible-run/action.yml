name: Run Ansible Playbook
description: Runs Ansible with inventory generation and specified playbook using SSH key authentication.

inputs:
  ansible_hosts:
    description: 'Line-separated list of Ansible host IPs'
    required: true
  ansible_user:
    description: 'Ansible SSH username'
    required: false
    default: 'root'
  ssh_private_key:
    description: 'SSH private key for authentication'
    required: true
  kubeconfig:
    description: 'Kubeconfig content (optional)'
    required: false
  playbook:
    description: 'Path to the Ansible playbook to run (relative to ansible/ directory)'
    required: true
  use_template_playbook:
    description: 'If true, use playbook from templates repo instead of calling repo'
    required: false
    default: 'false'
  use_template_helm_charts:
    description: 'If true, use helm-charts from templates repo instead of calling repo'
    required: false
    default: 'false'
  ansible_extra_env_json:
    description: 'Additional environment variables as JSON object (non-sensitive)'
    required: false
  ansible_extra_secrets_json:
    description: 'Additional secrets as JSON object (sensitive)'
    required: false
  base_image_registry:
    description: 'Base registry URL for the ansible-prod image'
    required: false
    default: 'ghcr.io/bmsj5/ci-cd-templates'

runs:
  using: composite
  steps:
    - name: Run Ansible Playbooks in Docker
      env:
        INPUT_ENV_JSON: ${{ inputs.ansible_extra_env_json }}
        INPUT_SECRETS_JSON: ${{ inputs.ansible_extra_secrets_json }}
        INPUT_KUBECONFIG: ${{ inputs.kubeconfig }}
        INPUT_PLAYBOOK: ${{ inputs.playbook }}
        INPUT_USE_TEMPLATE_PLAYBOOK: ${{ inputs.use_template_playbook }}
        INPUT_USE_TEMPLATE_HELM_CHARTS: ${{ inputs.use_template_helm_charts }}
      run: |
        # --- 1. Sanitize Inputs (Handle Null/Empty) ---
        [ -z "$INPUT_ENV_JSON" ] && INPUT_ENV_JSON="{}"
        [ -z "$INPUT_SECRETS_JSON" ] && INPUT_SECRETS_JSON="{}"

        # --- 2. Validating JSON Inputs ---
        if ! echo "$INPUT_ENV_JSON" | jq . >/dev/null 2>&1; then
          echo "Error: Invalid JSON in ansible_extra_env_json" >&2
          exit 1
        fi
        
        if ! echo "$INPUT_SECRETS_JSON" | jq . >/dev/null 2>&1; then
          echo "Error: Invalid JSON in ansible_extra_secrets_json" >&2
          exit 1
        fi
        
        # --- 3. Prepare Image ---
        IMAGE="${{ inputs.base_image_registry }}/ansible-prod:latest"
        echo "Ensuring image is available: $IMAGE"
        docker pull "$IMAGE" || { echo "Failed to pull image"; exit 1; }

        # --- 4. Prepare Docker Arguments ---
        MERGED_JSON=$(jq -s '.[0] * .[1]' <(echo "$INPUT_ENV_JSON") <(echo "$INPUT_SECRETS_JSON"))
        
        if [ "$INPUT_USE_TEMPLATE_PLAYBOOK" = "true" ]; then
          PLAYBOOK_PATH="templates/ansible/$INPUT_PLAYBOOK"
        else
          PLAYBOOK_PATH="ansible/$INPUT_PLAYBOOK"
        fi

        if [ "$INPUT_USE_TEMPLATE_HELM_CHARTS" = "true" ]; then
          HELM_CHARTS_PATH="/workspace/templates/helm-charts"
        else
          HELM_CHARTS_PATH="/workspace/helm-charts"
        fi

        DOCKER_ARGS=(
          -v "$GITHUB_WORKSPACE:/workspace"
          -e "ANSIBLE_CONFIG=/workspace/ansible/ansible.cfg"
          -e "ANSIBLE_HOSTS=${{ inputs.ansible_hosts }}"
          -e "ANSIBLE_USER=${{ inputs.ansible_user }}"
          -e "ANSIBLE_SSH_PRIVATE_KEY_FILE=/root/.ssh/id_rsa"
          -e "SSH_PRIVATE_KEY=${{ inputs.ssh_private_key }}"
          -e "ANSIBLE_SSH_ARGS=-o StrictHostKeyChecking=no"
          -e "PLAYBOOK_PATH=$PLAYBOOK_PATH"
          -e "HELM_CHARTS_PATH=$HELM_CHARTS_PATH"
        )

        if [ -n "$INPUT_KUBECONFIG" ]; then
          DOCKER_ARGS+=(-e "KUBECONFIG_CONTENT=$INPUT_KUBECONFIG")
        fi
        
        if [ "$MERGED_JSON" != "{}" ]; then
          while IFS= read -r line; do
            [ -n "$line" ] && DOCKER_ARGS+=(-e "$line")
          done < <(echo "$MERGED_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"')
        fi

        # --- 5. Execute Ansible ---
        docker run --rm "${DOCKER_ARGS[@]}" -w /workspace \
          "$IMAGE" \
          bash -c "
            # Setup SSH
            mkdir -p ~/.ssh
            echo \"\$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            
            if [ ! -s ~/.ssh/id_rsa ]; then
              echo 'Error: Failed to create SSH key file' >&2
              exit 1
            fi

            # Setup Kubeconfig
            if [ -n \"\$KUBECONFIG_CONTENT\" ]; then
              mkdir -p ~/.kube
              echo \"\$KUBECONFIG_CONTENT\" > ~/.kube/config
              chmod 600 ~/.kube/config
              export KUBECONFIG=~/.kube/config
              echo 'âœ… Kubeconfig injected successfully'
            fi
            
            # Run Playbooks
            echo 'Running generate_inventory.yml...'
            ansible-playbook templates/ansible/playbooks/generate_inventory.yml
            
            echo \"Running \$PLAYBOOK_PATH...\"
            ansible-playbook -i ansible/inventory.ini \"\$PLAYBOOK_PATH\"
          "
      shell: bash