# Dedicated collector for Kubernetes API server metrics
# Deployment with 1 replica = exactly 1 collector scraping exactly 1 endpoint
# No duplication, no hacks, no hash modding - just a simple single-replica deployment

mode: deployment
replicaCount: 1

image:
  repository: otel/opentelemetry-collector-contrib

resources:
  limits:
    cpu: 100m
    memory: 256Mi
  requests:
    cpu: 50ms
    memory: 192Mi

presets:
  kubernetesAttributes:
    enabled: true

clusterRole:
  create: true
  rules:
    # Permission to scrape API server metrics endpoint
    - nonResourceURLs: ["/metrics"]
      verbs: ["get"]
    # Permissions for Kubernetes service discovery (endpoints role)
    # Required for kubernetes_sd_configs to discover API server endpoints
    - apiGroups: [""]
      resources: ["endpoints", "services"]
      verbs: ["get", "list", "watch"]

service:
  enabled: false  # No need for service, this is internal only

extraEnvs:
  - name: OPENOBSERVE_AUTH_B64
    valueFrom:
      secretKeyRef:
        name: openobserve-creds
        key: auth_b64
  - name: APP_NAME
    valueFrom:
      configMapKeyRef:
        name: otel-env-labels
        key: APP_NAME
  - name: APP_VERSION
    valueFrom:
      configMapKeyRef:
        name: otel-env-labels
        key: APP_VERSION
  - name: REGION
    valueFrom:
      configMapKeyRef:
        name: otel-env-labels
        key: REGION
  - name: CLUSTER_ID
    valueFrom:
      configMapKeyRef:
        name: otel-env-labels
        key: CLUSTER_ID
  - name: DEPLOYMENT_ENV
    valueFrom:
      configMapKeyRef:
        name: otel-env-labels
        key: DEPLOYMENT_ENV

config:
  receivers:
    prometheus:
      config:
        scrape_configs:
          # -----------------------------------------------------------------------
          # KUBERNETES API SERVER - ONLY JOB IN THIS COLLECTOR
          # -----------------------------------------------------------------------
          - job_name: 'kubernetes-apiserver'
            scrape_interval: 15s
            metrics_path: /metrics
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            
            kubernetes_sd_configs:
              - role: endpoints
            
            relabel_configs:
              # Filter: Target the default/kubernetes service (The API Server)
              - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                action: keep
                regex: default;kubernetes;https

            metric_relabel_configs:
              # Keep only essential API server metrics used in Grafana dashboard
              - source_labels: [__name__]
                regex: '(apiserver_(requested_deprecated_apis|request_total|request_duration_seconds_(sum|count))|workqueue_depth|process_(cpu_seconds_total|resident_memory_bytes)|up)'
                action: keep

  processors:
    # Add external labels as resource attributes
    resource:
      attributes:
        - key: app.name
          value: ${env:APP_NAME}
          action: upsert
        - key: app.version
          value: ${env:APP_VERSION}
          action: upsert
        - key: region
          value: ${env:REGION}
          action: upsert
        - key: cluster.id
          value: ${env:CLUSTER_ID}
          action: upsert
        - key: env
          value: ${env:DEPLOYMENT_ENV}
          action: upsert
    # Convert these attributes to strings
    transform:
      error_mode: ignore
      metric_statements:
        - context: resource
          statements:
            - set(attributes["cluster.id"], Concat([attributes["cluster.id"]], ""))
    k8sattributes:
      auth_type: serviceAccount
      extract:
        metadata:
          - k8s.pod.name
          - k8s.namespace.name
          - k8s.node.name
    batch:
      timeout: 5s

  exporters:
    prometheusremotewrite:
      endpoint: "http://vm-vminsert.victoria-metrics.svc.cluster.local:8480/insert/0/prometheus"
      tls:
        insecure: true
      resource_to_telemetry_conversion:
        enabled: true
      remote_write_queue:
        queue_size: 20
      retry_on_failure:
        max_elapsed_time: 2m

  service:
    pipelines:
      metrics:
        receivers: [prometheus]
        processors: [resource, transform, k8sattributes, batch]
        exporters: [prometheusremotewrite]
