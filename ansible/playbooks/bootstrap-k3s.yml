- name: Bootstrap HA K3s Cluster
  hosts: all
  become: true
  vars_files:
    - group_vars/k3s.yml

  pre_tasks:
    - name: Get number of control plane nodes from environment
      ansible.builtin.set_fact:
        num_control_nodes: "{{ lookup('env', 'NUMBER_OF_CONTROL_PLANE_NODES') | default('', true) }}"
      run_once: true
    
    - name: Calculate node index in inventory
      ansible.builtin.set_fact:
        node_index: "{{ groups['all'].index(inventory_hostname) }}"
    
    - name: Set k3s_control_node fact based on NUMBER_OF_CONTROL_PLANE_NODES
      ansible.builtin.set_fact:
        k3s_control_node: >-
          {{ (num_control_nodes == '' or num_control_nodes is not defined) or
             (num_control_nodes | int > 0 and node_index < (num_control_nodes | int)) }}
    
    - name: "CoreDNS | Capture Control Plane IP"
      ansible.builtin.set_fact:
        # Uses whichever variable Ansible is currently using to connect
        k3s_public_ip: "{{ ansible_host | default(ansible_ssh_host) | default(inventory_hostname) }}"
      when: inventory_hostname == groups['all'][0]

    - name: "CoreDNS | Fetch kubeconfig to ephemeral runner"
      run_once: true
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ playbook_dir }}/k3s-kubeconfig"
        flat: yes
      when: inventory_hostname == groups['all'][0]

    - name: "CoreDNS | Deploy HA Chart (Delegated to Runner)"
      delegate_to: localhost
      run_once: true
      vars:
        target_api_ip: "{{ hostvars[groups['all'][0]]['k3s_public_ip'] }}"
      block:
        - name: "Prepare Kubeconfig for remote access"
          ansible.builtin.replace:
            path: "{{ playbook_dir }}/k3s-kubeconfig"
            regexp: '127\.0\.0\.1'
            replace: "{{ target_api_ip }}"

        - name: "Install CoreDNS via Helm Module"
          kubernetes.core.helm:
            name: coredns
            chart_ref: coredns
            chart_repo_url: https://coredns.github.io/helm
            release_namespace: kube-system
            kubeconfig: "{{ playbook_dir }}/k3s-kubeconfig"
            wait: true
            values:
              replicaCount: 3
              resources:
                limits:
                  cpu: 200m
                  memory: 100Mi
                requests:
                  cpu: 200m
                  memory: 100Mi
              affinity:
                podAntiAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                  - labelSelector:
                      matchExpressions:
                      - key: k8s-app
                        operator: In
                        values:
                        - kube-dns
                    topologyKey: kubernetes.io/hostname

              service:
                clusterIP: 10.43.0.10
                name: kube-dns
                annotations:
                  prometheus.io/port: "9153"
                  prometheus.io/scrape: "true"
                
              servers:
              - zones:
                - zone: .
                port: 53
                plugins:
                - name: errors
                - name: health
                  config:
                    port: 8080
                - name: ready
                - name: kubernetes
                  parameters: cluster.local in-addr.arpa ip6.arpa
                  config:
                    pods: insecure
                    fallthrough: in-addr.arpa ip6.arpa
                    ttl: 30
                - name: prometheus
                  parameters: 0.0.0.0:9153
                - name: forward
                  parameters: . /etc/resolv.conf
                - name: cache
                  parameters: 30
                - name: loop
                - name: reload
                - name: loadbalance

  roles:
    - role: xanmanning.k3s

  post_tasks:
    # -------------------------------------------------------------
    # Enable static CPU manager policy for CPU pinning
    # Official K3s method: https://docs.k3s.io/installation/configuration
    # This enables dedicated CPU cores for pods with Guaranteed QoS (integer CPU requests == limits)
    # -------------------------------------------------------------
    - name: Ensure K3s config directory exists
      ansible.builtin.file:
        path: /etc/rancher/k3s/config.yaml.d
        state: directory
        mode: "0755"

    - name: Get number of CPU cores
      ansible.builtin.command: nproc
      register: cpu_cores_result
      changed_when: false

    - name: Calculate kube-reserved CPU using GKE formula
      ansible.builtin.set_fact:
        cpu_cores: "{{ cpu_cores_result.stdout | int }}"
        reserved_cpu_m: >-
          {%- set cores = cpu_cores_result.stdout | int -%}
          {%- set total = 0 -%}
          {%- if cores >= 1 -%}
            {%- set total = total + 60 -%}
            {%- if cores >= 2 -%}
              {%- set total = total + 10 -%}
              {%- if cores >= 4 -%}
                {%- set total = total + 10 -%}
                {%- if cores > 4 -%}
                  {%- set total = total + ((cores - 4) * 2.5) | round(0, 'floor') | int -%}
                {%- endif -%}
              {%- elif cores == 3 -%}
                {%- set total = total + 5 -%}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}
            {%- set total = 60 -%}
          {%- endif -%}
          {{ total | int }}

    - name: Clear CPU manager state file before applying policy
      ansible.builtin.file:
        path: /var/lib/kubelet/cpu_manager_state
        state: absent
      failed_when: false

    - name: Configure static CPU manager policy
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/config.yaml.d/99-cpu-manager.yaml
        content: |
          kubelet-arg:
            - "cpu-manager-policy=static"
            - "system-reserved=cpu={{ reserved_cpu_m }}m"
        mode: "0644"
      notify: Restart K3s

    - name: Deploy Traefik HA HelmChartConfig manifest
      when:
        - k3s_control_node | bool
        - inventory_hostname == groups['all'][0]
      ansible.builtin.template:
        src: traefik-ha.yaml.j2
        dest: /var/lib/rancher/k3s/server/manifests/traefik-ha.yaml
        mode: "0644"


  handlers:
    - name: Restart K3s
      ansible.builtin.systemd:
        name: k3s
        state: restarted
        daemon_reload: yes