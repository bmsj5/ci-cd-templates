- name: Deploy GitHub Actions Runner for Organization
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - group_vars/github-runners.yml

  tasks:
    # --- Runner Scale Set Deployment ---
    - name: Get organization name and GitHub App credentials from environment
      ansible.builtin.set_fact:
        runner_organization: "{{ lookup('env', 'GITHUB_ORGANIZATION') }}"
        github_app_id: "{{ lookup('env', 'GITHUB_APP_ID') }}"
        github_app_installation_id: "{{ lookup('env', 'GITHUB_APP_INSTALLATION_ID') }}"
        github_app_private_key: "{{ lookup('env', 'GITHUB_APP_PRIVATE_KEY') | b64decode }}"
      no_log: true

    - name: Install Actions Runner Controller
      kubernetes.core.helm:
        name: arc
        chart_ref: oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller
        chart_version: "0.13.1"
        release_namespace: "arc-runners"
        create_namespace: true
        wait: true
        timeout: 5m

    - name: Install Runner Scale Set
      kubernetes.core.helm:
        name: arc-runner-set
        chart_ref: oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set
        chart_version: "0.13.1"
        release_namespace: "arc-runners"
        create_namespace: true
        wait: true
        timeout: 5m
        values:
          githubConfigUrl: "https://github.com/{{ runner_organization }}"
          githubConfigSecret:
            github_app_id: "{{ github_app_id }}"
            github_app_installation_id: "{{ github_app_installation_id }}"
            github_app_private_key: "{{ github_app_private_key }}"
          minRunners: "{{ arc_runner_max_concurrency }}"
          maxRunners: "{{ arc_runner_max_concurrency }}"
          containerMode:
            type: kubernetes
          template:
            spec:
              nodeSelector:
                role: ci-runner
              volumes:
                - name: docker-sock
                  emptyDir: {}
                - name: work
                  emptyDir: {}
                - name: dind-storage
                  hostPath:
                    path: /opt/arc-runner-cache
                    type: DirectoryOrCreate
              containers:
                - name: runner
                  image: ghcr.io/actions/actions-runner:latest
                  command: 
                    - "sh"
                    - "-c"
                    - |
                      echo "Waiting for Docker Socket at /var/run/docker.sock..."
                      for i in $(seq 1 10); do
                        if [ -S /var/run/docker.sock ]; then
                          echo "✅ Socket found after $i seconds! Starting Runner..."      
                          # 'exec' replaces the shell with the runner process
                          # This is important for signal handling (cancelling jobs)
                          exec /home/runner/run.sh
                        fi
                        sleep 1
                      done                  
                      echo "❌ Timeout: Docker socket never appeared after 10s."
                      echo "   (Check the docker-daemon sidecar logs!)"
                      exit 1
                  env:
                    - name: DOCKER_HOST
                      value: unix:///var/run/docker.sock
                    - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
                      value: "false"
                    - name: ACTIONS_RUNNER_CONTAINER_HOOKS
                      value: ""
                  volumeMounts:
                    - name: docker-sock
                      mountPath: /var/run
                - name: docker-daemon
                  env:
                    - name: MAX_CACHE_SLOTS
                      value: "{{ arc_runner_max_concurrency | string }}"
                  image: docker:dind
                  securityContext:
                    privileged: true
                  volumeMounts:
                    - name: docker-sock
                      mountPath: /var/run
                    - name: work
                      mountPath: /home/runner/_work
                    - name: dind-storage
                      mountPath: /mnt/runner-cache
                  command:
                    - sh
                    - -c
                    - |
                      echo "Initializing Docker with slot limit: ${MAX_CACHE_SLOTS:-1}"

                      # Loop through slots 1 to N
                      for i in $(seq 1 "${MAX_CACHE_SLOTS:-1}"); do
                        SLOT_DIR="/mnt/runner-cache/slot-$i"
                        LOCK_FILE="/mnt/runner-cache/slot-$i.lock"
                        
                        mkdir -p "$SLOT_DIR"
                        
                        # Check if we can acquire the lock (non-blocking test)
                        if flock -n "$LOCK_FILE" true; then
                          echo "✅ Found free slot: $i"
                          
                          # We found a free slot! 
                          # Now EXEC replaces the shell process with flock -> dockerd.
                          # The lock is held as long as dockerd runs.
                          exec flock "$LOCK_FILE" dockerd \
                            --host=unix:///var/run/docker.sock \
                            --group=1001 \
                            --data-root="$SLOT_DIR" \
                            --features='{"buildkit": true}'
                        fi
                        
                        echo "Slot $i is busy, checking next..."
                      done
                      
                      echo "❌ CRITICAL: All cache slots are busy!"
                      exit 1
      no_log: true