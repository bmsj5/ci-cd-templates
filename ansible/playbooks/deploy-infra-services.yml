---
- name: Deploy Core Infrastructure Services
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    # --- cert-manager Installation ---
    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: cert-manager
        chart_repo_url: https://charts.jetstack.io
        chart_version: v1.19.2
        release_namespace: cert-manager
        create_namespace: true
        wait: true
        timeout: 5m
        set_values:
          - value: installCRDs=true
            value_type: raw
    
    - name: Create Let's Encrypt ClusterIssuer
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: "{{ lookup('env', 'LETS_ENCRYPT_EMAIL') }}"
              privateKeySecretRef:
                name: letsencrypt-prod-key
              solvers:
                - http01:
                    ingress:
                      class: traefik

    # --- Kube-State-Metrics Installation ---
    - name: Add prometheus-community Helm repository
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: Install kube-state-metrics
      kubernetes.core.helm:
        name: kube-state-metrics
        chart_ref: prometheus-community/kube-state-metrics
        chart_version: 7.0.0
        release_namespace: kube-system
        create_namespace: true
        values_files:
          - "{{ lookup('env', 'HELM_CHARTS_PATH') }}/kube-state-metrics/values.yml"
        wait: true
        timeout: 5m